openapi: 3.0.3
info:
  title: IncentEdge API
  description: |
    Infrastructure's Bloomberg Terminal for Incentives - API for discovering, matching, and managing incentive programs.

    ## Authentication
    Most endpoints require JWT bearer token authentication. Obtain tokens via Supabase Auth.

    ## Rate Limiting
    - Free tier: 10 requests/minute
    - Professional: 60 requests/minute
    - Enterprise: 600 requests/minute

    ## Support
    - Email: api-support@incentedge.com
    - Docs: https://docs.incentedge.com
  version: 1.0.0
  contact:
    name: IncentEdge API Support
    email: api-support@incentedge.com
    url: https://incentedge.com/support
  license:
    name: Proprietary
    url: https://incentedge.com/terms

servers:
  - url: https://incentedge.com/api
    description: Production server
  - url: http://localhost:3000/api
    description: Development server

tags:
  - name: Programs
    description: Search and retrieve incentive programs
  - name: Projects
    description: Manage infrastructure projects
  - name: Calculate
    description: Calculate potential incentive values
  - name: Health
    description: Service health checks
  - name: Stats
    description: Platform statistics
  - name: Applications
    description: Track grant applications
  - name: Analytics
    description: Advanced analytics
  - name: Reports
    description: Generate reports
  - name: Organizations
    description: Organization management

security:
  - bearerAuth: []

paths:
  /programs:
    get:
      tags:
        - Programs
      summary: Search incentive programs
      description: Search and filter through 30,000+ incentive programs with advanced criteria
      operationId: searchPrograms
      security: []
      parameters:
        - $ref: '#/components/parameters/CategoryParam'
        - $ref: '#/components/parameters/StateParam'
        - $ref: '#/components/parameters/CountyParam'
        - $ref: '#/components/parameters/ProgramTypeParam'
        - $ref: '#/components/parameters/SectorParam'
        - $ref: '#/components/parameters/TechnologyParam'
        - $ref: '#/components/parameters/StatusParam'
        - $ref: '#/components/parameters/DirectPayParam'
        - $ref: '#/components/parameters/TransferableParam'
        - $ref: '#/components/parameters/SearchParam'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/SortByParam'
        - $ref: '#/components/parameters/SortOrderParam'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgramListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
    head:
      tags:
        - Programs
      summary: Get program statistics
      description: Returns program counts by category in headers
      operationId: getProgramStats
      security: []
      responses:
        '200':
          description: Successful response
          headers:
            X-Total-Programs:
              schema:
                type: integer
              description: Total active programs
            X-Federal-Count:
              schema:
                type: integer
              description: Federal programs count
            X-State-Count:
              schema:
                type: integer
              description: State programs count
            X-Local-Count:
              schema:
                type: integer
              description: Local programs count
            X-Utility-Count:
              schema:
                type: integer
              description: Utility programs count

  /programs/{id}:
    get:
      tags:
        - Programs
      summary: Get program by ID
      description: Retrieve detailed information for a specific program
      operationId: getProgramById
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: Program UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Program'
        '404':
          $ref: '#/components/responses/NotFound'

  /projects:
    get:
      tags:
        - Projects
      summary: List projects
      description: Get all projects for authenticated user's organization
      operationId: listProjects
      parameters:
        - name: id
          in: query
          description: Specific project ID
          schema:
            type: string
        - name: status
          in: query
          description: Filter by project status
          schema:
            type: string
            enum: [active, planning, in_development, completed]
        - name: sector
          in: query
          description: Filter by sector
          schema:
            type: string
        - $ref: '#/components/parameters/SearchParam'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Projects
      summary: Create project
      description: Create a new infrastructure project
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Project'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /projects/{id}:
    get:
      tags:
        - Projects
      summary: Get project by ID
      description: Retrieve detailed project information
      operationId: getProjectById
      parameters:
        - name: id
          in: path
          required: true
          description: Project UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'

  /calculate:
    post:
      tags:
        - Calculate
      summary: Calculate incentives
      description: Calculate potential incentive values for a hypothetical project
      operationId: calculateIncentives
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateRequest'
      responses:
        '200':
          description: Calculation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Comprehensive health check with dependency status
      operationId: healthCheck
      security: []
      parameters:
        - name: quick
          in: query
          description: Quick liveness check only
          schema:
            type: boolean
        - name: verbose
          in: query
          description: Include detailed metrics
          schema:
            type: boolean
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
    head:
      tags:
        - Health
      summary: Liveness probe
      description: Simple liveness check (returns 200 if running)
      operationId: livenessProbe
      security: []
      responses:
        '200':
          description: Service is alive

  /stats:
    get:
      tags:
        - Stats
      summary: Platform statistics
      description: Get comprehensive platform statistics and metrics
      operationId: getStats
      security: []
      parameters:
        - name: quick
          in: query
          description: Quick stats for KPIs only
          schema:
            type: boolean
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Supabase Auth

  parameters:
    CategoryParam:
      name: category
      in: query
      description: Program category filter
      schema:
        type: string
        enum: [federal, state, local, utility]

    StateParam:
      name: state
      in: query
      description: Two-letter state code
      schema:
        type: string
        pattern: '^[A-Z]{2}$'
        example: NY

    CountyParam:
      name: county
      in: query
      description: County name
      schema:
        type: string

    ProgramTypeParam:
      name: program_type
      in: query
      description: Type of program
      schema:
        type: string
        enum: [tax_credit, grant, rebate, loan, tax_deduction, tax_exemption]

    SectorParam:
      name: sector
      in: query
      description: Sector type
      schema:
        type: string

    TechnologyParam:
      name: technology
      in: query
      description: Technology type
      schema:
        type: string

    StatusParam:
      name: status
      in: query
      description: Program status
      schema:
        type: string
        enum: [active, inactive, expired, pending]
        default: active

    DirectPayParam:
      name: direct_pay_eligible
      in: query
      description: IRA direct pay eligibility
      schema:
        type: boolean

    TransferableParam:
      name: transferable
      in: query
      description: Transferable tax credit
      schema:
        type: boolean

    SearchParam:
      name: search
      in: query
      description: Full-text search query
      schema:
        type: string

    PageParam:
      name: page
      in: query
      description: Page number (1-indexed)
      schema:
        type: integer
        minimum: 1
        default: 1

    LimitParam:
      name: limit
      in: query
      description: Results per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    SortByParam:
      name: sort_by
      in: query
      description: Sort field
      schema:
        type: string
        enum: [name, created_at, updated_at, amount_max, application_deadline, popularity_score]
        default: popularity_score

    SortOrderParam:
      name: sort_order
      in: query
      description: Sort direction
      schema:
        type: string
        enum: [asc, desc]
        default: desc

  schemas:
    Program:
      type: object
      properties:
        id:
          type: string
          format: uuid
        external_id:
          type: string
          example: "IRA-45L"
        name:
          type: string
          example: "Section 45L New Energy Efficient Home Credit"
        short_name:
          type: string
          example: "45L Tax Credit"
        description:
          type: string
        summary:
          type: string
        program_type:
          type: string
          enum: [tax_credit, grant, rebate, loan, tax_deduction, tax_exemption]
        category:
          type: string
          enum: [federal, state, local, utility]
        sector_types:
          type: array
          items:
            type: string
        technology_types:
          type: array
          items:
            type: string
        building_types:
          type: array
          items:
            type: string
        amount_min:
          type: number
          nullable: true
        amount_max:
          type: number
          nullable: true
        direct_pay_eligible:
          type: boolean
        transferable:
          type: boolean
        status:
          type: string
          enum: [active, inactive, expired, pending]
        source_url:
          type: string
          format: uri
        confidence_score:
          type: number
          minimum: 0
          maximum: 1
        popularity_score:
          type: integer
          minimum: 0
          maximum: 100

    ProgramListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Program'
        meta:
          type: object
          properties:
            page:
              type: integer
            limit:
              type: integer
            total:
              type: integer
            totalPages:
              type: integer
            hasNextPage:
              type: boolean
            hasPrevPage:
              type: boolean
        filters_applied:
          type: object

    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        sector_type:
          type: string
        building_type:
          type: string
        state:
          type: string
        total_development_cost:
          type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateProjectRequest:
      type: object
      required:
        - name
        - sector_type
        - building_type
        - construction_type
        - address_line1
        - city
        - state
        - zip_code
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
        sector_type:
          type: string
          enum: [real-estate, clean-energy, water, waste, transportation, industrial]
        building_type:
          type: string
        construction_type:
          type: string
          enum: [new-construction, substantial-rehab, acquisition, refinance]
        address_line1:
          type: string
        city:
          type: string
        state:
          type: string
          pattern: '^[A-Z]{2}$'
        zip_code:
          type: string
        county:
          type: string
        total_sqft:
          type: number
        total_units:
          type: number
        total_development_cost:
          type: number
        domestic_content_eligible:
          type: boolean
        prevailing_wage_commitment:
          type: boolean

    ProjectListResponse:
      type: object
      properties:
        success:
          type: boolean
        portfolio:
          type: object
        projects:
          type: array
          items:
            $ref: '#/components/schemas/Project'
        fallback:
          type: boolean

    CalculateRequest:
      type: object
      required:
        - state
        - totalDevelopmentCost
        - equityInvestment
      properties:
        state:
          type: string
          pattern: '^[A-Z]{2}$'
        county:
          type: string
        municipality:
          type: string
        buildingType:
          type: string
          enum: [multifamily, commercial, mixed_use, industrial, residential]
        totalUnits:
          type: integer
        totalSqft:
          type: number
        affordableUnits:
          type: integer
        affordablePercentage:
          type: number
        totalDevelopmentCost:
          type: number
        equityInvestment:
          type: number
        projectedNOI:
          type: number
        holdPeriod:
          type: integer
        sustainabilityTier:
          type: string
          enum: [tier_1_efficient, tier_2_high_performance, tier_3_net_zero]
        solarCapacityKw:
          type: number
        storageCapacityKwh:
          type: number
        entityType:
          type: string
          enum: [corporation, partnership, llc, nonprofit, tax_exempt]

    CalculateResponse:
      type: object
      properties:
        project:
          type: object
        results:
          type: object
          properties:
            incentives:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  type:
                    type: string
                  category:
                    type: string
                  estimatedValue:
                    type: number
                  confidence:
                    type: number
                  eligible:
                    type: boolean
                  notes:
                    type: array
                    items:
                      type: string
            totals:
              type: object
              properties:
                federal:
                  type: number
                state:
                  type: number
                local:
                  type: number
                utility:
                  type: number
                total:
                  type: number
            roiImpact:
              type: object
              properties:
                baseIRR:
                  type: number
                enhancedIRR:
                  type: number
                irrLift:
                  type: number
                equityMultipleLift:
                  type: number
        meta:
          type: object

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy, alive]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        uptime:
          type: integer
        checks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              status:
                type: string
                enum: [pass, warn, fail]
              message:
                type: string
              lastChecked:
                type: string
                format: date-time
        metrics:
          type: object

    StatsResponse:
      type: object
      properties:
        incentives:
          type: object
          properties:
            total:
              type: integer
            active:
              type: integer
            by_category:
              type: object
        awards:
          type: object
          properties:
            total:
              type: integer
            success_rate:
              type: number
        coverage:
          type: object
          properties:
            states_covered:
              type: integer
            states_list:
              type: array
              items:
                type: string
        platform:
          type: object
        value:
          type: object
        meta:
          type: object

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
        requestId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized - missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
